import re
import pathlib

import helper_tpls
import tool_img

import tool_static


BASE_DIR = pathlib.Path(__file__).parent

CFG = {
    "测试微信客服": {
        "WX_NAME": "富贵杠上花",
        "语气风格": "中肯",
        "性格关键词": "活泼",
        "字数上限": 100,
        "会话提示词模版": "1766401795.1807850.3385.html",
    },
    "获取视频内容": {
        "提示词": "请提取目标短视频详细信息:{url}",
    },
    "主动评价模版": {
        "模版文件": "主动评价模版.html",
        "历史回复": None,
        "url": None,
    },
    
    "主动评价模版_图文": {
        "模版文件": "主动评价模版_图文.html",
        "历史回复": None,
        "封面文字描述": None,
        "视频截图": None,
    },
    "通用会话回复": {
        "模版文件": "通用沟通回复模版.html",
        # "UP主昵称": "月亮正在充电",
        # "回复网友名": None,
        "语气风格": "中肯",
        "性格关键词": "活泼",
        "字数上限": 100,
        "会话提示词模版": "通用沟通回复模版.html",
        "网友评论截图": None,
        "背景知识库": "",
    },
    "月亮正在充电回复自己视频的评论": {
        "模版文件": "评论回复模版.html",
        "UP主昵称": "月亮正在充电",
        "回复网友名": None,
        "语气风格": "中肯",
        "性格关键词": "活泼",
        "字数上限": 100,
        "会话提示词模版": "评论回复模版.html",
        "网友评论截图": None,
        "背景知识库": """商业的本质是诚信 核心知识库
一、核心主题定位
本知识库围绕 **“商业的本质是诚信，共赢才是长久之道”** 展开，聚焦买卖双方互惠关系、相互尊重的商业准则、抵制不法平台漏洞、信任国家监管力量等核心方向，传递 “诚信经营、理性消费、正向维权” 的正能量价值观，适用于短视频文案、网友回复、评论区互动等场景。
二、核心观点拆解（含阐释、正能量表达、应用示例）
1. 核心观点一：买卖双方其实是互惠互利的
核心阐释
商业的本质是价值交换，买方通过付费获得符合预期的商品 / 服务，卖方通过提供价值获得合理收益，诚信是维系这种交换的基础。失去诚信，买方会遭遇 “货不对板”，卖方会失去客户信任，最终双输。只有坚守诚信，才能实现 “买方满意、卖方盈利” 的互惠共赢。
正能量表达
买卖不是 “零和博弈”，而是彼此成就的伙伴关系。
你放心消费，我用心经营，这才是商业该有的样子。
互惠的前提是诚信，没有诚信的交易，都是一次性的 “一锤子买卖”。
应用示例（短视频文案 / 网友回复）
视频文案：“买的放心，卖的安心，买卖双方本就该互惠互利，诚信就是最好的纽带～”
网友回复：“没错！我作为消费者愿意为好产品付费，也希望商家能守信用，这样大家都好。”
2. 核心观点二：应该相互尊重，相互提供便利
核心阐释
商业活动中，买卖双方、商家与平台之间都应保持相互尊重：商家尊重消费者的知情权、公平交易权，消费者尊重商家的合理利润，平台尊重商家的经营权益与消费者的维权诉求。同时，彼此提供便利（如商家简化售后流程、平台优化交易界面、消费者理性反馈问题），才能降低交易成本，提升商业效率。
正能量表达
尊重是前提，便利是加分项，诚信是底线。
商家多一份耐心，消费者多一份理解，平台多一份公平，商业环境会更温暖。
相互提供便利不是 “妥协”，而是让商业回归 “服务本质” 的智慧。
应用示例（短视频文案 / 网友回复）
视频文案：“商家保障品质，消费者理性反馈，相互尊重、彼此便利，这才是健康的商业生态～”
网友回复：“太对了！我遇到过好商家，售后很贴心，我也会主动给好评，相互尊重真的很重要。”
3. 核心观点三：不要让不法平台钻空子
核心阐释
部分不法平台利用信息差、规则漏洞，损害商家或消费者利益（如偏袒一方、纵容假货、克扣商家收益等）。面对这种情况，买卖双方应保持警惕，主动识别漏洞，联合发声抵制，同时通过合法途径维权，不让不法平台成为 “破坏诚信的帮凶”。
正能量表达
钻空子的平台走不远，坚守诚信的才会被时间认可。
我们不是要对抗谁，而是要不让不法平台有可乘之机。
识别漏洞、理性维权，是保护自己，也是净化商业环境。
应用示例（短视频文案 / 网友回复）
视频文案：“不法平台总想钻空子，但只要我们保持警惕、联合起来，就没人能破坏诚信的规则～”
网友回复：“是的！我之前遇到过平台漏洞，后来联合其他消费者反馈，终于得到了解决，不能让他们钻空子。”
4. 核心观点四：国家监管正在进行中，大家要对政府有信心，市场经营环境会越来越好
核心阐释
近年来，国家不断加强对电商平台、市场交易的监管力度（如出台《电子商务法》《消费者权益保护法》等法律法规，开展平台专项整治行动），目的是打击不法行为，保护买卖双方合法权益。随着监管体系的完善，市场经营环境会越来越公平、透明，我们应相信政府的监管力量，主动配合监管，共同维护诚信环境。
正能量表达
国家监管是诚信的 “保护伞”，对政府有信心，就是对未来的商业环境有信心。
专项整治、法规完善，我们能看到市场在变得越来越好。
相信政府的力量，也相信我们每个人的努力，诚信商业环境指日可待。
应用示例（短视频文案 / 网友回复）
视频文案：“别担心，国家监管一直在行动，只要我们耐心等待、积极配合，市场环境一定会越来越好～”
网友回复：“没错！我看到很多不法平台被整治了，相信政府，我们的权益会越来越有保障。”
三、正能量延伸观点（补充方向）
1. 诚信经营是企业的 “长寿基因”
表达：短期看，诚信可能让商家 “少赚一点”；长期看，诚信是品牌的无形资产，能带来源源不断的客户。
示例：“那些百年老店，靠的不是低价，而是代代相传的诚信。”
2. 个人的诚信行为能推动行业进步
表达：消费者理性维权、商家诚信经营，每一个微小的诚信行为，都能汇聚成净化行业的力量。
示例：“你今天的一次理性反馈，可能会让明天的商业环境更公平。”
3. 行业自律与监管并行，才能实现长久健康发展
表达：国家监管是 “外部约束”，行业自律是 “内部自觉”，两者结合，才能让商业回归诚信本质。
示例：“平台主动规范自己，加上国家监管，诚信商业环境会来得更快。”
四、应用场景话术库
1. 短视频台词（结合拍摄场景：电动车 + 遮阳伞，10 秒内，分风格）
（1）俏皮日常类（适配轻松场景）
台词 1：“这小车配伞超方便，就像买卖双方，相互便利才舒心～”
拍摄动作：女生摸伞沿笑看镜头，说完轻拍车身，带点俏皮感。
台词 2：“防晒伞护我，诚信护买卖，互惠互利才是王道～”
拍摄动作：镜头扫过伞面，女生对着镜头比 “OK” 手势，语气轻快。
（2）哲理升华类（适配视频结尾）
台词 1：“商业的本质是诚信，共赢才会走得远～”
拍摄动作：女生表情认真，对着镜头缓慢说出，结尾点头强调。
台词 2：“国家监管在行动，诚信商业环境越来越好～”
拍摄动作：镜头拉远，女生靠在电动车上，微笑说出，充满信心。
2. 网友回复常用话术（分场景）
（1）网友支持 “诚信商业” 观点（如 “说得对！诚信太重要了”）
回复 1：感谢支持！诚信是商业的底线，我们一起守护～
回复 2：没错！只要大家都重视诚信，商业环境会越来越好。
回复 3：是的！买卖双方互惠互利，才是商业该有的样子。
（2）网友分享被骗经历（如 “我之前买东西被坑了，商家不讲诚信”）
回复 1：抱抱你！遇到这种情况一定要理性维权，国家监管一直在行动，相信会有公道～
回复 2：这种商家走不远的！我们要主动抵制，不让不法平台钻空子。
回复 3：感谢分享！你的经历能提醒更多人，诚信真的很重要。
（3）网友质疑 “诚信能赚钱吗”（如 “现在很多商家靠低价不诚信，也赚了很多钱”）
回复 1：短期可能赚快钱，但长期看，诚信才是企业的 “长寿基因”，那些百年老店就是最好的例子～
回复 2：国家监管正在整治这种现象，相信未来不诚信的商家会越来越难生存～
回复 3：其实很多诚信商家也做得很好，互惠互利才是长久之道。
（4）网友询问 “如何维护诚信环境”（如 “我们普通人能做什么”）
回复 1：我们可以理性消费、主动维权，同时支持诚信商家，这就是在为诚信环境出力～
回复 2：遇到不法平台钻空子，及时反馈给监管部门，不让他们有可乘之机～
回复 3：从自己做起，做诚信的消费者，也提醒身边的人重视诚信。
五、核心传播关键词（用于视频标签、评论区互动）
商业的本质是诚信、买卖互惠互利、相互尊重相互便利、抵制不法平台、国家监管在行动、诚信经营、理性消费、正向维权、市场环境越来越好、共赢才是长久之道""",
    },
}


# fp = open('/mnt/56T/tmp/test.json', 'r')
# 全局缓存.任务数据 = json.load(fp)
# fp.close()
# 全局缓存.任务数据['WX_NAME'] = '富贵杠上花'
# 全局缓存.任务数据.update(性格关键词='活泼')
# 全局缓存.任务数据.update(语气风格='中肯')
# 全局缓存.任务数据.update(字数上限=100)
# img_url = job.上传文件(tool_img.b642bin(全局缓存.任务数据.get('会话截图')), suffix='.jpg')
# print(img_url)
# 全局缓存.任务数据.update(会话截图=img_url)
# url = 'https://file.j1.sale/api/file/2025-12-22/1766401795.1807850.3385.html'
# html = helper_tpls.render_template_url_to_string(url, **全局缓存.任务数据)

# url = job.上传文件(html)
# print(f'''请严格根据链接中的提示词执行:
# {url}''')


def 获得模版(fname):
    return BASE_DIR / fname.strip()


def 渲染模版(fname, kwargs):
    with open(获得模版(fname), encoding="utf-8") as f:
        return helper_tpls.render_template_string_to_string(f.read(), kwargs)


def 处理回复网友名称(line: str):
    """
    处理回复网友名称 的 Docstring

    :param line: 说明
    :type line: str

    >>> 处理回复网友名称("回复 @镜子（关注上限明日必关）")
    '@镜子（关注上限明日必关）'
    """
    return re.sub(r"^回复\s*", "", line) if line else line


def 获得豆包提示词(d: dict):
    """
    获得豆包提示词 的 Docstring

    :param d: 说明
    :type d: dict
    """
    类型 = d.get("类型")

    cfg = CFG.get(类型).copy()

    if 类型 == "获取视频内容":
        return cfg.get("提示词").format(**d), True

    fname = cfg.pop("模版文件")

    if d.get("回复"):
        cfg["回复网友名"] = 处理回复网友名称(d.pop("回复"))

    if d.get("截屏"):
        cfg["网友评论截图"] = d.pop("截屏")

    # print(fname, cfg)
    cfg.update(d)

    return 渲染模版(fname, cfg), False


if __name__ == "__main__":
    import doctest

    d1 = {
        "截屏": "https://file.j1.sale/api/file/tmp/2025-12-29/36f6b8e6-e48e-11f0-bfb6-0242ac120006.jpg",
        "回复": "回复 @镜子（关注上限明日必关）",
        "类型": "月亮正在充电回复自己视频的评论",
    }

    print(doctest.testmod(verbose=False, report=False))
