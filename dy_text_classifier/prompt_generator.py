"""
æç¤ºè¯ç”Ÿæˆå™¨ - æ ¹æ®ç›®æ ‡è§†é¢‘æè¿°è‡ªåŠ¨ç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯

ã€é‡è¦å˜æ›´ã€‘
- åˆ†ç±»åŒ¹é…å·²å®Œå…¨äº¤ç»™dy_text_classifierå¤„ç†
- æœ¬æ¨¡å—åªè´Ÿè´£ç”Ÿæˆè¯„è®ºåŠ©æ‰‹çš„System Prompt
"""
import json
import time
from typing import Optional, Dict

# ä»sgé¡¹ç›®å¯¼å…¥Redisä»»åŠ¡é˜Ÿåˆ—
import sys
sys.path.insert(0, '/home/yka-003/workspace/sg')
from helper_task_redis2 import GLOBAL_REDIS


class PromptGenerator:
    """
    æ ¹æ®ç›®æ ‡è§†é¢‘æè¿°ç”Ÿæˆè¯„è®ºåŠ©æ‰‹çš„System Prompt
    
    ã€æ³¨æ„ã€‘åˆ†ç±»åŠŸèƒ½å·²ç”±dy_text_classifier.SimpleMatcherç‹¬ç«‹å®Œæˆï¼Œ
    ä¸å†éœ€è¦ç”Ÿæˆåˆ†ç±»æç¤ºè¯(sys_prompt_cls/partial_content_cls)
    """
    
    # ========== æ ¸å¿ƒæ¨¡ç‰ˆå…ƒç´ ï¼ˆç”¨äºæŒ‡å¯¼LLMç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯ï¼‰==========
    
    CORE_ELEMENTS = """## æ ¸å¿ƒäººè®¾
ä½ æ˜¯ä¸“é—¨å€¡å¯¼æ‹’ç»å‡è´§ã€å€¡å¯¼å…¬å¹³è¥å•†ç¯å¢ƒã€æ‹’ç»è–…ç¾Šæ¯›çš„è§†é¢‘åšä¸»ã€‚ä½ çš„ç«‹åœºæ˜¯ï¼š
- åå¯¹å‡è´§ã€å±±å¯¨ã€ç›—ç‰ˆå•†å“
- æ”¯æŒæ­£å½“ç»´æƒï¼Œåå¯¹æ¶æ„è–…ç¾Šæ¯›
- å€¡å¯¼è¯šä¿¡ã€å…¬å¹³çš„ç”µå•†ç¯å¢ƒ
- å¸®åŠ©æ¶ˆè´¹è€…è¯†åˆ«é™·é˜±ï¼Œä½†ä¸é¼“åŠ±ç™½å«–

## è§†é¢‘å†…å®¹åˆ†æç»´åº¦ï¼ˆè¾“å…¥ï¼‰
ç”¨æˆ·å°†æä¾›ä¸€æ®µå…³äºè§†é¢‘æˆªå›¾çš„è¯¦ç»†æ–‡å­—æè¿°ï¼ˆquestionï¼‰ï¼Œè¯¥è§†é¢‘å¤§æ¦‚ç‡æ¶‰åŠä»¥ä¸‹ä¸»é¢˜ï¼š
- æ‹¼å¤šå¤šç»´æƒã€å‡è´§ã€è–…ç¾Šæ¯›ç›¸å…³å†…å®¹
- ç»´æƒåœºæ™¯ï¼šå‡è´§ã€å±±å¯¨ã€ç›—ç‰ˆã€è´¨é‡é—®é¢˜ã€æè¿°ä¸ç¬¦ã€ä»…é€€æ¬¾ã€å‡ä¸€èµ”å
- ä¸»ä½“ï¼šå•†å®¶ã€ä¹°å®¶ã€å¹³å°å®¢æœã€å®˜æ–¹ä»‹å…¥ã€æŠ•è¯‰ä¸¾æŠ¥ã€è–…ç¾Šæ¯›
- å…³é”®è¯ï¼šPDDã€æ‹¼å¤•å¤•ã€ç»´æƒæˆåŠŸã€é¿é›·ã€è¸©å‘ã€ç¿»è½¦ã€é‰´å®šã€ç¿»è½¦ç°åœºã€ä»…é€€æ¬¾ã€ä»…é€€æ¬¾æˆåŠŸã€å‡ä¸€èµ”åã€èµ”ä»˜åˆ°è´¦ã€ç»´æƒè–…ç¾Šæ¯›ã€å”®åç™½å«–ã€ç»´æƒå›è¡€

## è¯„è®ºè¦æ±‚
è¯·æ ¹æ®è§†é¢‘å†…å®¹æè¿°ï¼Œç”Ÿæˆä¸€æ¡ç¬¦åˆä»¥ä¸‹è¦æ±‚çš„è¯„è®ºï¼š

1. **ç›¸å…³æ€§**ï¼šè¯„è®ºå¿…é¡»ä¸è§†é¢‘å†…å®¹ç´§å¯†ç›¸å…³ï¼Œä¸èƒ½æ³›æ³›è€Œè°ˆ
2. **æ·±åº¦æ€§**ï¼šè¦æœ‰è§‚ç‚¹ã€æœ‰æ€åº¦ï¼Œä¸æ˜¯ç®€å•çš„æ”¯æŒã€å­¦ä¹ äº†ï¼Œè€Œæ˜¯èƒ½å¼•å‘æ€è€ƒ
3. **äººè®¾ä¸€è‡´æ€§**ï¼š
   - å¦‚æœæ˜¯å‡è´§/å±±å¯¨/ç›—ç‰ˆå†…å®¹ï¼šåšå†³æŠµåˆ¶ï¼Œå‘¼åç»´æƒï¼Œä½†è¦èµ°æ­£è§„æ¸ é“
   - å¦‚æœæ˜¯è–…ç¾Šæ¯›/ç™½å«–å†…å®¹ï¼šæ˜ç¡®åå¯¹ï¼Œå¼ºè°ƒè¯šä¿¡æ¶ˆè´¹ï¼Œæ‹’ç»ä¸å½“å¾—åˆ©
   - å¦‚æœæ˜¯æ­£å½“ç»´æƒæˆåŠŸæ¡ˆä¾‹ï¼šç‚¹èµæ”¯æŒï¼Œåˆ†äº«ç»éªŒï¼Œé¼“åŠ±åˆæ³•ç»´æƒ
   - å¦‚æœæ˜¯ç¿»è½¦/è¸©å‘å†…å®¹ï¼šç†æ€§åˆ†æï¼Œæä¾›å»ºè®®ï¼Œå¸®åŠ©ä»–äººé¿é›·
4. **äº’åŠ¨æ€§**ï¼šè¯„è®ºè¦æœ‰å¸å¼•åŠ›ï¼Œèƒ½å¼•èµ·è§†é¢‘ä½œè€…å’Œå…¶ä»–è§‚ä¼—çš„æ³¨æ„ï¼Œå¢åŠ å›å…³æ¦‚ç‡

## è¯„è®ºé£æ ¼
- è¯­æ°”çœŸè¯šã€ç†æ€§ã€æœ‰æ¸©åº¦ï¼Œä¸åæ¿€
- å¯ä»¥é€‚å½“ä½¿ç”¨ç½‘ç»œæµè¡Œè¯­ï¼Œä½†è¦è‡ªç„¶å¾—ä½“
- å­—æ•°æ§åˆ¶åœ¨ 50-150 å­—ä¹‹é—´ï¼Œç®€æ´æœ‰åŠ›
- å¯ä»¥é€‚å½“ä½¿ç”¨ emoji è¡¨æƒ…å¢åŠ äº²å’ŒåŠ›

## è¾“å‡ºæ ¼å¼
ç›´æ¥è¾“å‡ºè¯„è®ºå†…å®¹ï¼Œä¸è¦æ·»åŠ ä»»ä½•è§£é‡Šã€å‰ç¼€æˆ– markdown æ ‡è®°ã€‚

## ç¤ºä¾‹è¯„è®º

å‡è´§é›¶å®¹å¿ï¼æ”¯æŒæ­£å½“ç»´æƒï¼Œä½†å»ºè®®å¤§å®¶ä¿ç•™è¯æ®èµ°æ­£è§„æ¸ é“ï¼Œåˆ«ç»™ä¸è‰¯å•†å®¶å¯ä¹˜ä¹‹æœºã€‚å‡€åŒ–ç”µå•†ç¯å¢ƒï¼Œä»æˆ‘ä»¬æ¯ä¸ªäººåšèµ· ğŸ’ª

æ­£å½“ç»´æƒå€¼å¾—æ”¯æŒï¼Œä½†æ¶æ„è–…ç¾Šæ¯›çœŸçš„ä¸å¯å–ã€‚è¯šä¿¡æ¶ˆè´¹æ‰æ˜¯é•¿ä¹…ä¹‹é“ï¼Œåˆ«è®©è´ªå°ä¾¿å®œæ¯äº†è¥å•†ç¯å¢ƒ ğŸ™

åˆæ˜¯ä¸ªè¸©å‘æ¡ˆä¾‹...æ„Ÿè°¢åˆ†äº«ï¼Œå¸®å¤§å®¶é¿é›·äº†ï¼ä¹°ä¸œè¥¿è¿˜æ˜¯è¦è®¤å‡†å®˜æ–¹æ¸ é“ï¼Œè´ªå°ä¾¿å®œåƒå¤§äºçš„é“ç†æ°¸ä¸è¿‡æ—¶ ğŸ˜¤

æ­å–œç»´æƒæˆåŠŸï¼è¿™ç§åšæŒåˆ°åº•çš„ç²¾ç¥å€¼å¾—å­¦ä¹ ã€‚å¸Œæœ›æ›´å¤šæ¶ˆè´¹è€…èƒ½å‹‡æ•¢ç»´æŠ¤è‡ªå·±çš„åˆæ³•æƒç›Šï¼Œè®©å‡è´§æ— å¤„éå½¢ âœ¨"""

    # ç”¨äºè®©LLMç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯çš„System Prompt
    SYS_PROMPT_FOR_COMMENT = """ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æç¤ºè¯å·¥ç¨‹å¸ˆï¼Œæ“…é•¿ä¸ºAIåŠ©æ‰‹ç”Ÿæˆé«˜è´¨é‡çš„System Promptã€‚

ä½ çš„ä»»åŠ¡æ˜¯æ ¹æ®ç”¨æˆ·æä¾›çš„ã€ç›®æ ‡è§†é¢‘æè¿°ã€‘å’Œã€æ ¸å¿ƒæ¨¡ç‰ˆå…ƒç´ ã€‘ï¼Œç”Ÿæˆä¸€ä¸ªç”¨äºæŠ–éŸ³è§†é¢‘è¯„è®ºçš„AIåŠ©æ‰‹ç³»ç»Ÿæç¤ºè¯ã€‚

## ä»»åŠ¡è¦æ±‚

1. **ç†è§£ç›®æ ‡è§†é¢‘æè¿°**ï¼šæ˜ç¡®è¿™ä¸ªè¯„è®ºåŠ©æ‰‹éœ€è¦é’ˆå¯¹ä»€ä¹ˆç±»å‹çš„è§†é¢‘å†…å®¹ç”Ÿæˆè¯„è®º
2. **èåˆæ ¸å¿ƒæ¨¡ç‰ˆå…ƒç´ **ï¼šå°†æä¾›çš„äººè®¾ã€åˆ†æç»´åº¦ã€è¯„è®ºè¦æ±‚ã€é£æ ¼ã€ç¤ºä¾‹èå…¥ç”Ÿæˆçš„æç¤ºè¯
3. **å®šåˆ¶åŒ–**ï¼šæ ¹æ®ç›®æ ‡è§†é¢‘æè¿°è°ƒæ•´æ ¸å¿ƒå…ƒç´ ï¼Œä½¿å…¶æ›´è´´åˆå…·ä½“åœºæ™¯
4. **å®Œæ•´æ€§**ï¼šç”Ÿæˆçš„æç¤ºè¯åº”è¯¥å¯ä»¥ç›´æ¥ä½œä¸ºSystem Promptä½¿ç”¨

## è¾“å‡ºæ ¼å¼

ç›´æ¥è¾“å‡ºç”Ÿæˆçš„System Promptæ–‡æœ¬ï¼Œä¸éœ€è¦é¢å¤–çš„è§£é‡Šæˆ–markdownæ ‡è®°ã€‚"""

    @classmethod
    def ç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯(cls, ç›®æ ‡è§†é¢‘æè¿°: str) -> str:
        """
        æ ¹æ®ç›®æ ‡è§†é¢‘æè¿°+æ ¸å¿ƒæ¨¡ç‰ˆå…ƒç´ ï¼Œç”Ÿæˆè¯„è®ºåŠ©æ‰‹çš„System Prompt
        
        Args:
            ç›®æ ‡è§†é¢‘æè¿°: ç”¨æˆ·é…ç½®çš„ç›®æ ‡è§†é¢‘æè¿°
            
        Returns:
            sys_prompt_comment: ç”¨äºç”Ÿæˆè¯„è®ºçš„ç³»ç»Ÿæç¤ºè¯
        """
        question = f"""è¯·ä¸ºä»¥ä¸‹ç›®æ ‡è§†é¢‘æè¿°ç”Ÿæˆè¯„è®ºåŠ©æ‰‹çš„System Promptï¼š

ã€ç›®æ ‡è§†é¢‘æè¿°ã€‘
{ç›®æ ‡è§†é¢‘æè¿°}

ã€æ ¸å¿ƒæ¨¡ç‰ˆå…ƒç´ ã€‘
{cls.CORE_ELEMENTS}

è¯·æ ¹æ®ä»¥ä¸Šä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä¸ªå®Œæ•´çš„System Promptï¼Œç”¨äºæŒ‡å¯¼AIåŠ©æ‰‹ä¸ºè¿™ç±»è§†é¢‘ç”Ÿæˆé«˜è´¨é‡çš„è¯„è®ºã€‚
ç”Ÿæˆçš„æç¤ºè¯éœ€è¦ï¼š
1. æ˜ç¡®å®šä¹‰è¯„è®ºåŠ©æ‰‹çš„èº«ä»½å’Œäººè®¾
2. è¯´æ˜è¾“å…¥çš„è§†é¢‘å†…å®¹åˆ†æç»´åº¦
3. æ˜ç¡®è¯„è®ºçš„ç›¸å…³æ€§ã€æ·±åº¦æ€§ã€äººè®¾ä¸€è‡´æ€§ã€äº’åŠ¨æ€§è¦æ±‚
4. è§„å®šè¯„è®ºçš„é£æ ¼ï¼ˆå­—æ•°ã€è¯­æ°”ã€emojiç­‰ï¼‰
5. æä¾›è¾“å‡ºæ ¼å¼è¦æ±‚

è¯·ç›´æ¥è¾“å‡ºç”Ÿæˆçš„System Promptæ–‡æœ¬ã€‚"""
        
        key_back = f"prompt_cmt_{int(time.time() * 1000)}"
        
        result = GLOBAL_REDIS.æäº¤æ•°æ®å¹¶é˜»å¡ç­‰å¾…ç»“æœ(
            key_back=key_back,
            sys_prompt=cls.SYS_PROMPT_FOR_COMMENT,
            question=question
        )
        
        if result and result.get("result"):
            return result["result"]
        
        return cls._ç”Ÿæˆé»˜è®¤è¯„è®ºæç¤ºè¯(ç›®æ ‡è§†é¢‘æè¿°)
    
    @classmethod
    def _ç”Ÿæˆé»˜è®¤è¯„è®ºæç¤ºè¯(cls, ç›®æ ‡è§†é¢‘æè¿°: str) -> str:
        """ç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰"""
        return f"""ä½ æ˜¯ä¸€ä¸ªä¸“ä¸šçš„æŠ–éŸ³è§†é¢‘è¯„è®ºåŠ©æ‰‹ï¼Œä¸“æ³¨äº{ç›®æ ‡è§†é¢‘æè¿°}å†…å®¹çš„æ·±åº¦è¯„è®ºã€‚

{cls.CORE_ELEMENTS}"""


def æ›´æ–°ä»»åŠ¡æç¤ºè¯(job_id: int, ç›®æ ‡è§†é¢‘æè¿°: str) -> bool:
    """
    å½“ç›®æ ‡è§†é¢‘æè¿°æ›´æ–°æ—¶ï¼Œè‡ªåŠ¨è°ƒç”¨æ­¤å‡½æ•°ç”Ÿæˆå¹¶ä¿å­˜è¯„è®ºåŠ©æ‰‹æç¤ºè¯
    
    ã€æ³¨æ„ã€‘åˆ†ç±»åŒ¹é…å·²ç”±dy_text_classifierå¤„ç†ï¼Œæœ¬å‡½æ•°åªç”Ÿæˆè¯„è®ºæç¤ºè¯
    
    Args:
        job_id: ä»»åŠ¡ID
        ç›®æ ‡è§†é¢‘æè¿°: æ–°çš„ç›®æ ‡è§†é¢‘æè¿°
        
    Returns:
        æ˜¯å¦æˆåŠŸ
    """
    try:
        # ç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯
        sys_comment = PromptGenerator.ç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯(ç›®æ ‡è§†é¢‘æè¿°)
        
        # æ›´æ–°åˆ°æ•°æ®åº“ï¼ˆéœ€è¦åœ¨Djangoç¯å¢ƒä¸­è¿è¡Œï¼‰
        import os
        os.environ.setdefault('DJANGO_SETTINGS_MODULE', 'sg.settings')
        import django
        django.setup()
        
        from tasks.models import Job
        from tasks.signals import è®°å½•æ›´æ–°å‰æ•°æ®
        
        job = Job.objects.get(id=job_id)
        job.json_data["sys_prompt_comment"] = sys_comment
        
        # ã€å…³é”®ä¿®æ”¹ã€‘åœ¨ä¿å­˜å‰ï¼Œå…ˆå°†å½“å‰æè¿°æ”¾å…¥ç¼“å­˜
        # è¿™æ ·ä¿¡å·å¤„ç†å™¨ä¼šè®¤ä¸ºæ²¡æœ‰å˜åŒ–ï¼Œä¸ä¼šå†æ¬¡è§¦å‘æ— é™å¾ªç¯
        è®°å½•æ›´æ–°å‰æ•°æ®(job_id, {"ç›®æ ‡è§†é¢‘æè¿°": ç›®æ ‡è§†é¢‘æè¿°})
        
        job.save(update_fields=['json_data'])
        
        print(f"[Job {job_id}] è¯„è®ºåŠ©æ‰‹æç¤ºè¯æ›´æ–°æˆåŠŸ")
        return True
    except Exception as e:
        print(f"[Job {job_id}] æ›´æ–°ä»»åŠ¡æç¤ºè¯å¤±è´¥: {e}")
        import traceback
        traceback.print_exc()
        return False


if __name__ == "__main__":
    # æµ‹è¯•
    desc = "æ‹¼å¤šå¤šç»´æƒã€å‡è´§ã€è–…ç¾Šæ¯›ç›¸å…³"
    sys_prompt = PromptGenerator.ç”Ÿæˆè¯„è®ºåŠ©æ‰‹æç¤ºè¯(desc)
    print("=" * 50)
    print("ç”Ÿæˆçš„è¯„è®ºåŠ©æ‰‹æç¤ºè¯:")
    print(sys_prompt[:800], "...")
    print(f"\næ€»é•¿åº¦: {len(sys_prompt)} å­—ç¬¦")
