from enum import Enum, unique
import tool_env


TRANS_MAP = {
    "血压检测": "血压记录",
    "血糖检测": "血糖记录",
    "餐食拍摄": "热量记录",
    "医疗相关报告": "医疗报告",
    "体重拍摄": "体重记录",
    "睡眠报告": "睡眠报告",
    "血氧检测": "血氧记录",
    "心率变异性分析报告": "心率变异性分析报告",
}


@unique
class 图片文件类别(Enum):
    """图片与文件类别枚举类，用于图片内容的分类标识"""

    血压检测 = "血压检测"  # 包含收缩压、舒张压、脉搏（或高压、低压、脉搏）等血压相关文字，及典型血压测量仪器品牌相关文字
    血糖检测 = "血糖检测"  # 包含血糖、典型血糖单位（如mmol/L）等文字，及典型血糖测量仪器品牌相关文字
    医疗相关报告 = "医疗相关报告"  # 包含出院记录、病历、门诊记录、住院记录、检查报告、检验报告、手术记录等医疗检验检查相关文字
    餐食拍摄 = "餐食拍摄"  # 包含食物、菜品、食材等相关文字
    体重拍摄 = "体重拍摄"  # 包含体重、体重单位（如kg）等文字，及体重仪品牌相关文字
    睡眠报告 = "睡眠报告"  # 包含睡眠、睡眠质量、睡眠时间等相关文字（截图或拍摄）
    血氧检测 = "血氧检测"  # 包含血氧、脉搏等相关文字，及典型血氧仪器品牌相关文字
    心率变异性分析报告 = "心率变异性分析报告"  # 明确标注为心率变异性分析报告，包含心率变异性指标、姓名、年龄、性别等相关内容
    其它 = "其它"  # 不属于以上任何分类的图片


def generate_image_classification_prompt():
    """生成图片分类判断的系统提示词，重点完善医疗相关报告的判别说明"""
    # 从ocr_medical_reports_data.py提取的37项医疗报告子类
    medical_subtypes = [
        # 常规体检相关
        "常规体检报告（综合性基础体检，含身高、体重、血尿常规等基础项）",
        "入职体检报告（企业要求的入职专项体检，通常含传染病筛查等）",
        "体检复查报告（针对首次体检异常项的复查报告）",
        "体检总结报告（多项目体检后的综合结论，含健康建议）",
        "健康体检套餐报告（特定套餐类体检，如中老年套餐、女性套餐等）",
        # 门诊相关
        "门诊报告（门诊就诊后的检查/诊断结论）",
        "门诊病历（门诊接诊时的病程记录，含主诉、查体、初步诊断）",
        "门诊处方报告（门诊开具的药品处方单）",
        "急诊报告（急诊科就诊产生的检查/诊断报告）",
        "急诊病历（急诊科的病程记录，含抢救、处理过程）",
        # 住院相关
        "住院报告（住院期间的综合诊疗记录）",
        "出院小结（出院时的总结，含入院情况、治疗过程、出院医嘱）",
        "住院病历（详细的住院病程记录，含每日病情变化）",
        "手术记录报告（手术过程的详细记录，含术式、术中情况）",
        "入院记录（患者入院时的基本情况、病史、初步诊断）",
        # 检验类报告（血液/体液等）
        "血常规报告（血液细胞计数等基础检查）",
        "尿常规报告（尿液成分检测）",
        "生化检查报告（肝肾功能、电解质等生化指标）",
        "血糖检查报告（空腹/餐后血糖检测）",
        "血脂检查报告（总胆固醇、甘油三酯等）",
        "肿瘤标志物报告（癌胚抗原、甲胎蛋白等）",
        "传染病筛查报告（乙肝、丙肝、梅毒、HIV等）",
        "凝血功能报告（凝血四项、凝血因子等检测）",
        "甲状腺功能报告（甲状腺激素如T3、T4、TSH等）",
        # 影像/功能类报告
        "超声检查报告（B超、彩超，如腹部、心脏、血管超声）",
        "CT检查报告（计算机断层扫描，如胸部CT、头部CT）",
        "核磁共振报告（MRI检查，如脑部、关节MRI）",
        "X光检查报告（胸部、骨骼等X线检测）",
        "心电图报告（常规心电图、动态心电图Holter）",
        "内镜检查报告（胃镜、肠镜、支气管镜等）",
        "PET_CT报告（正电子发射断层显像，用于肿瘤筛查等）",
        "病理报告（组织/细胞活检后的病理诊断，如活检、手术标本）",
        # 其他专项报告
        "会诊报告（多科室联合会诊后的结论）",
        "远程会诊报告（跨机构远程会诊记录）",
        "慢病管理报告（高血压、糖尿病等慢性病随访记录）",
        "疫苗接种报告（疫苗接种记录及证明）",
        "体检异常通知书（针对体检异常项的单独通知，如结节、指标超标）",
        "其他报告（未覆盖的特殊医疗报告类型）",
    ]

    medical_subtypes = '; '.join(map(lambda a:f'{a[0]+1}:{a[1]}', enumerate(medical_subtypes)))
    # 构建系统提示词
    sys_prompt = f"""
            你是图片分类判断的专家。
            用户输入是已经ocr识别过的图片内容，文本格式。
            你可以通过这些文本内容判断这张图片的类别，返回将是一个json格式的结果。

            ***有如下图片分类可供选择***：
            1,血压检测, 也就是血压检测, 分类理由: 包含了收缩压, 舒张压, 脉搏等, 或者或者高压, 低压, 脉搏等和血压相关的文字, 以及典型的血压测量仪器品牌等相关的文字。
            2,血糖检测, 也就是血糖检测, 分类理由: 包含了血糖, 典型的血糖单位mmol/L等文字, 以及典型的血糖测量仪器品牌等相关的文字,都属于血糖检测类别
            3,医疗相关报告, 也就是医疗相关检验检查等, 含有以下任一子类相关的文字：{medical_subtypes}。只要包含上述任何一种医疗报告的特征文字（如"门诊病历"、"血常规报告"、"CT检查报告"等），均属于此类。
            4,餐食拍摄, 也就是餐食拍摄, 分类理由: 包含了食物, 菜品, 食材等相关的文字。
            5,体重拍摄, 也就是体重拍摄, 分类理由: 包含了体重, 体重单位kg, 体重仪品牌等相关的文字。
            6,睡眠报告, 也就是睡眠报告截图或拍摄, 分类理由: 包含了睡眠, 睡眠质量, 睡眠时间, 睡眠质量等相关的文字。
            7,血氧检测, 也就是血氧检测, 分类理由: 包含了血氧, 脉搏, 血氧仪器品牌等相关的文字。
            8,心率变异性分析报告, 也就是心率变异性分析报告, 分类理由: 明确写明是, 心率变异性分析报告, 包含了心率变异性指标, 姓名, 年龄, 性别等相关的内容。
            100,其它, 不属于以上分类的图片, 分类理由: 不属于以上分类的图片

            请仔细判断分类， 放入返回的json中

            ***返回的json示例***：
            {{"id":1, "分类":"血压检测", "分类理由":"..."}}
            {{"id":3, "分类":"医疗相关报告", "分类理由":"..."}}

            ***注意有以下要求***：
            a，返回的结果必须是以上正确的json格式
            b, 请注意分类的准确性, 必须已罗列的分类理由和其相关意义延展进行分类
            c, 请注意分类的范围, 必须是以上分类的中的一个
            d, 请注意, 如果含有尿酸文字,但仍然包含血糖字样,那么也属于血糖检测, 而不是尿酸检测
            e, json结构需要完整,不能有任何缺失。
        """
    return tool_env.remove_leading_whitespace(sys_prompt)

IMAGE_CLASSIFICATION_PROMPT = generate_image_classification_prompt()

# 使用示例
if __name__ == "__main__":
    print(f"总共定义了 {len(图片文件类别)} 种图片与文件类别")
    for category in 图片文件类别:
        print(f"{category.name}: {category.value}")
