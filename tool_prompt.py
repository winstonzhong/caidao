# -*- coding: utf-8 -*-
"""
提示词管理器工具

通过快捷的函数调用返回内置的提示词模板
key 格式: 动作|方式|结果|app

>>> 获取提示词("截图解析", "附件", "文本")
'请竭尽所能的,最为详细地, 描述这张图片所包含的所有内容。'

>>> 获取提示词("截图解析", "附件", "文本", app="微信")
'请竭尽所能的,最为详细地, 描述这张微信界面截图所包含的所有内容。'

>>> "area_name" in 获取提示词("截图解析", "附件", "json")
True

>>> 获取提示词("截图解析", "附件", "json", app="抖音")
Traceback (most recent call last):
    ...
KeyError: "提示词模板不存在: key='截图解析|附件|json|抖音', kwargs={}"

>>> 获取提示词("不存在", "动作", "文本") # doctest: +IGNORE_EXCEPTION_DETAIL
Traceback (most recent call last):
    ...
KeyError
"""


# ============================================================================
# 全局提示词模板字典
# 参数用 | 连接作为 key: 动作|方式|结果|app
# 支持 {{变量名}} 模板语法（双大括号会被 format 转为单大括号）
# 如需保留字面量大括号，使用 {{{{ 和 }}}} 转义
# ============================================================================
提示词模板库 = {
    # 截图解析 - 附件 - 文本 - 通用(空app)
    "截图解析|附件|文本|": "请竭尽所能的,最为详细地, 描述这张图片所包含的所有内容。",
    # 截图解析 - 附件 - 文本 - 微信
    "截图解析|附件|文本|微信": "请竭尽所能的,最为详细地, 描述这张微信界面截图所包含的所有内容。",
    # 截图解析 - 附件 - json - 通用(空app)
    # 注意：模板中使用 {{{{ 和 }}}} 来保留 JSON 字面量大括号
    "截图解析|附件|json|": """请解析这张App界面截图，识别出所有可点击交互的区域，并严格按照以下要求输出：
1. **输出格式**：必须是 JSON 数组，每个元素代表一个可点击区域
2. **必填字段**：
    - `area_name`：区域的名称（例如"添加朋友按钮"）
    - `description`：该区域的功能描述（例如"点击后进入添加朋友页面"）。**特别注意：如果识别的是输入框（如搜索框、评论输入框、回复输入框等），请在 description 尾部追加输入框中的当前文本内容，使用特殊标记 `【输入内容:内容文本】` 包裹，例如："点击后可输入搜索关键词【输入内容:手机壳】"或"点击后可激活输入框进行评论回复【输入内容:你好棒】"
    - `coordinates`：区域的**中心坐标**，以屏幕宽高为 1.0 的相对浮点数表示，格式为 `[0.xxx, 0.xxx]`，**坐标值必须保留小数点后3位**（例如 `[0.152, 0.083]`）
3. **坐标规则**：屏幕左上角为原点 `(0, 0)`，右下角为 `(1, 1)`，坐标需反映区域的中心点位置
4. **识别范围**（**重要，必须全部识别**）：
    - **基础可点击元素**：按钮、图标、文字链接、头像、导航栏选项、功能入口
    - **通知红点标记**：
      * 列表项右侧的红色数字标记（如消息数量"1"、"99+"等）
      * 纯红色圆点标记（无数字的小红点）
      * 导航栏上的消息通知红点
      * **特别注意**：红点标记本身是一个独立的可点击区域，必须单独列出
    - **表情/快捷回复图标**：聊天界面中的表情符号、快捷回复按钮、动态表情图标等
5. **标记命名规范**：
    - 红点标记：`area_name` 应包含"红点"或"未读标记"，如"阿骨朵万粉群未读红点"
    - 表情图标：`area_name` 应包含"表情"或"快捷回复"，如"悠悠快捷表情"
示例输出片段：
```json
[
  {{
    "area_name": "添加朋友按钮",
    "description": "点击进入添加朋友的界面",
    "coordinates": [0.152, 0.083]
  }},
  {{
    "area_name": "阿骨朵万粉群未读红点",
    "description": "显示未读消息数量为1的红色数字标记，点击可进入群聊查看消息",
    "coordinates": [0.852, 0.245]
  }},
  {{
    "area_name": "悠悠快捷表情图标",
    "description": "右侧的表情符号快捷回复按钮，点击可快速发送表情",
    "coordinates": [0.912, 0.368]
  }},
  {{
    "area_name": "底部导航消息红点",
    "description": "导航栏消息选项卡上的未读红点标记",
    "coordinates": [0.625, 0.952]
  }},
  {{
    "area_name": "搜索输入框",
    "description": "点击后可输入关键词进行搜索【输入内容:连衣裙】",
    "coordinates": [0.450, 0.065]
  }},
  {{
    "area_name": "评论输入框",
    "description": "点击后可激活输入框，输入文字进行评论回复【输入内容:这个视频太棒了！】",
    "coordinates": [0.299, 0.955]
  }}
]
```""",
}


# ============================================================================
# 工具函数
# ============================================================================
def 获取提示词(动作: str, 方式: str, 结果: str, app: str = "", **kwargs) -> str:
    """
    根据参数获取对应的提示词

    参数按顺序拼接成 key（动作|方式|结果|app），从提示词模板库中查找对应的模板，
    然后使用 kwargs 中的变量进行模板渲染（使用 str.format()）

    Args:
        动作: 操作动作，如"截图解析"
        方式: 处理方式，如"附件"
        结果: 结果格式，如"文本"、"json"
        app: 应用名称，默认为空字符串，用于组成 key 的一部分
        **kwargs: 模板渲染所需的变量（模板中使用 {变量} 语法）

    Returns:
        str: 渲染后的提示词

    Raises:
        KeyError: 当找不到对应的提示词模板时抛出

    >>> 获取提示词("截图解析", "附件", "文本")
    '请竭尽所能的,最为详细地, 描述这张图片所包含的所有内容。'

    >>> 获取提示词("截图解析", "附件", "文本", app="微信")
    '请竭尽所能的,最为详细地, 描述这张微信界面截图所包含的所有内容。'

    >>> 获取提示词("截图解析", "附件", "json")[:100] == 提示词模板库.get('截图解析|附件|json|')[:100]
    True


    >>> 获取提示词("截图解析", "附件", "json", app="抖音")
    Traceback (most recent call last):
        ...
    KeyError: "提示词模板不存在: key='截图解析|附件|json|抖音', kwargs={}"

    >>> 获取提示词("不存在", "动作", "文本") # doctest: +IGNORE_EXCEPTION_DETAIL
    Traceback (most recent call last):
        ...
    KeyError
    """
    # 构建 key：动作|方式|结果|app
    key = f"{动作}|{方式}|{结果}|{app}"

    # 从模板库中查找
    if key not in 提示词模板库:
        raise KeyError(f"提示词模板不存在: key='{key}', kwargs={kwargs}")

    # 获取模板
    template = 提示词模板库[key]

    # 使用 str.format() 渲染模板
    return template.format(**kwargs)

if __name__ == "__main__":
    import doctest

    print(doctest.testmod(verbose=False))
