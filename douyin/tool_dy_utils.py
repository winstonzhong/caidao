import pandas as pd
import re
import tool_time
import numpy as np


def ç½‘å‹è¯„è®ºè§£æ(line: str) -> list[dict]:
    """
    è§£æå•è¡Œç½‘å‹è¯„è®ºæ–‡æœ¬ï¼Œæå–å…³é”®ä¿¡æ¯å¹¶è¿”å›å­—å…¸åˆ—è¡¨

    å‚æ•°:
        line: å•è¡Œè¯„è®ºæ–‡æœ¬ï¼ŒåŒ…å«ç½‘å‹ä¿¡æ¯ã€è¡Œä¸ºã€æ—¶é—´ã€bounds boxç­‰

    è¿”å›:
        list[dict]: åŒ…å«ä»¥ä¸‹å­—æ®µçš„å­—å…¸åˆ—è¡¨ï¼š
            - ç½‘å‹åç§°: strï¼Œç½‘å‹çš„æ˜µç§°ï¼ˆæ— åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
            - è¯„è®ºå†…å®¹: strï¼Œè¯„è®º/å›å¤çš„å…·ä½“å†…å®¹ï¼ˆæ— åˆ™ä¸ºç©ºå­—ç¬¦ä¸²ï¼‰
            - æ˜¯å¦éœ€å›å¤: boolï¼Œæ˜¯å¦åŒ…å«"å›å¤è¯„è®º å›å¤,æŒ‰é’®"ç‰¹å¾
            - left: intï¼Œbounds boxå·¦åæ ‡
            - top: intï¼Œbounds boxä¸Šåæ ‡
            - right: intï¼Œbounds boxå³åæ ‡
            - bottom: intï¼Œbounds boxä¸‹åæ ‡

    Doctestæµ‹è¯•ç”¨ä¾‹:
    >>> # æµ‹è¯•1ï¼šä»…åŒ…å«bounds boxçš„ç©ºè¡Œ
    >>> ç½‘å‹è¯„è®ºè§£æ(" (0, 2167, 1080, 2236)")
    {'ç½‘å‹åç§°': '', 'è¯„è®ºå†…å®¹': '', 'æ˜¯å¦éœ€å›å¤': False, 'left': 0, 'top': 2167, 'right': 1080, 'bottom': 2236}
    >>> # æµ‹è¯•2ï¼šèµäº†ä½ çš„è¯„è®ºï¼Œæ— å›å¤æŒ‰é’®
    >>> line2 = "é­æ™“æ¨±Queençš„å¤´åƒ é­æ™“æ¨±Queen èµäº†ä½ çš„è¯„è®º 1åˆ†é’Ÿå‰ (0, 204, 1080, 447)"
    >>> ç½‘å‹è¯„è®ºè§£æ(line2)
    {'ç½‘å‹åç§°': 'é­æ™“æ¨±Queen', 'è¯„è®ºå†…å®¹': '', 'æ˜¯å¦éœ€å›å¤': False, 'left': 0, 'top': 204, 'right': 1080, 'bottom': 447}
    >>> # æµ‹è¯•3ï¼šè¯„è®ºäº†ä½ ï¼ŒåŒ…å«å›å¤æŒ‰é’®ï¼ˆéœ€å›å¤ï¼‰
    >>> line3 = "å”¯æœ‰æ¬¢å–œçš„å¤´åƒ å”¯æœ‰æ¬¢å–œ ç²‰ä¸ è¯„è®ºäº†ä½ : æ–°å¹´å¿«ä¹ 1åˆ†é’Ÿå‰ å›å¤è¯„è®º å›å¤,æŒ‰é’® èµ èµ,æŒ‰é’® (0, 447, 1080, 709)"
    >>> res3 = ç½‘å‹è¯„è®ºè§£æ(line3)
    >>> res3['ç½‘å‹åç§°'], res3['è¯„è®ºå†…å®¹'], res3['æ˜¯å¦éœ€å›å¤']
    ('å”¯æœ‰æ¬¢å–œ', 'æ–°å¹´å¿«ä¹', True)
    >>> res3['left'], res3['top'], res3['right'], res3['bottom']
    (0, 447, 1080, 709)
    >>> # æµ‹è¯•4ï¼šå¸¦è¡¨æƒ…çš„è¯„è®ºå†…å®¹
    >>> line4 = "èŠ±æœ¨è“çš„å¤´åƒ èŠ±æœ¨è“ è¯„è®ºäº†ä½ : æˆ‘ä¹Ÿä¸çŸ¥é“æœ‰å•¥ç”¨[å¤§ç¬‘][å¤§ç¬‘] 23åˆ†é’Ÿå‰ å›å¤è¯„è®º å›å¤,æŒ‰é’® èµ èµ,æŒ‰é’® (0, 622, 1080, 1136)"
    >>> d = ç½‘å‹è¯„è®ºè§£æ(line4)
    >>> d['è¯„è®ºå†…å®¹']
    'æˆ‘ä¹Ÿä¸çŸ¥é“æœ‰å•¥ç”¨[å¤§ç¬‘][å¤§ç¬‘]'
    >>> d["æ˜¯å¦éœ€å›å¤"]
    True
    >>> # æµ‹è¯•5ï¼šä½œè€…å›å¤çš„åœºæ™¯
    >>> line5 = "èŠ±æœ¨è“çš„å¤´åƒ èŠ±æœ¨è“ ä½œè€… å›å¤: æ˜¯çš„ï¼Œäººé—´çƒŸç«æ°”æ¯[å¤§ç¬‘] 32åˆ†é’Ÿå‰ å›å¤è¯„è®º å›å¤,æŒ‰é’® èµ èµ,æŒ‰é’® (0, 1379, 1080, 1711)"
    >>> res5 = ç½‘å‹è¯„è®ºè§£æ(line5)
    >>> res5['ç½‘å‹åç§°'], res5['è¯„è®ºå†…å®¹']
    ('èŠ±æœ¨è“', 'æ˜¯çš„ï¼Œäººé—´çƒŸç«æ°”æ¯[å¤§ç¬‘]')
    >>> res5['æ˜¯å¦éœ€å›å¤']
    False
    >>> # æµ‹è¯•6ï¼šåç§°å«ç‰¹æ®Šå­—ç¬¦çš„åœºæ™¯
    >>> line6 = "å†œæ‘é˜¿å¨Ÿå¸¦å¨ƒè®°ï¼ˆæ–°äººèµ·æ­¥ï¼‰çš„å¤´åƒ å†œæ‘é˜¿å¨Ÿå¸¦å¨ƒè®°ï¼ˆæ–°äººèµ·æ­¥ï¼‰ èµäº†ä½ çš„è¯„è®º 7åˆ†é’Ÿå‰ (0, 1195, 1080, 1438)"
    >>> ç½‘å‹è¯„è®ºè§£æ(line6)['ç½‘å‹åç§°']
    'å†œæ‘é˜¿å¨Ÿå¸¦å¨ƒè®°ï¼ˆæ–°äººèµ·æ­¥ï¼‰'
    >>> # æµ‹è¯•7ï¼šèµäº†ä½ çš„å›¾æ–‡åœºæ™¯
    >>> line7 = "èŠ±æœ¨è“çš„å¤´åƒ èŠ±æœ¨è“ èµäº†ä½ çš„å›¾æ–‡ 23åˆ†é’Ÿå‰ (0, 1136, 1080, 1379)"
    >>> ç½‘å‹è¯„è®ºè§£æ(line7)['è¯„è®ºå†…å®¹']
    ''
    >>> ç½‘å‹è¯„è®ºè§£æ(line7)['æ˜¯å¦éœ€å›å¤']
    False
    """
    # åˆå§‹åŒ–è¿”å›ç»“æœ

    # æ­£åˆ™åŒ¹é…è¡Œæœ«å°¾çš„bounds boxï¼ˆæ•è·left/top/right/bottomï¼‰
    bounds_pattern = re.compile(r"\((\d+),\s*(\d+),\s*(\d+),\s*(\d+)\)$")
    bounds_match = bounds_pattern.search(line)

    # æå–bounds boxåæ ‡ï¼ˆé»˜è®¤0ï¼Œé˜²æ­¢åŒ¹é…å¤±è´¥ï¼‰
    left = int(bounds_match.group(1)) if bounds_match else 0
    top = int(bounds_match.group(2)) if bounds_match else 0
    right = int(bounds_match.group(3)) if bounds_match else 0
    bottom = int(bounds_match.group(4)) if bounds_match else 0

    # å»æ‰bounds boxåçš„çº¯æ–‡æœ¬å†…å®¹ï¼ˆç”¨äºæå–å…¶ä»–ä¿¡æ¯ï¼‰
    text_without_bounds = bounds_pattern.sub("", line).strip()

    # 1. æå–ç½‘å‹åç§°ï¼šåŒ¹é…"çš„å¤´åƒ"åçš„åç§°ï¼ˆç›´åˆ°é‡åˆ°ç²‰ä¸/ä½œè€…/èµäº†/è¯„è®ºäº†ä½ /å›å¤:ç­‰å…³é”®è¯ï¼‰
    # name_pattern = re.compile(
    #     r"çš„å¤´åƒ\s+([^(\s+ç²‰ä¸|\s+ä½œè€…|\s+èµäº†|\s+è¯„è®ºäº†ä½ |\s+å›å¤:)]+)"
    # )
    name_pattern = re.compile(r"(.+?)çš„å¤´åƒ")
    name_match = name_pattern.search(text_without_bounds)
    ç½‘å‹åç§° = name_match.group(1).strip() if name_match else ""

    # 2. æå–è¯„è®ºå†…å®¹ï¼šä¼˜å…ˆåŒ¹é…"è¯„è®ºäº†ä½ :"ï¼Œå…¶æ¬¡åŒ¹é…"å›å¤:"ï¼Œæ— åˆ™ä¸ºç©º
    content_pattern1 = re.compile(r"è¯„è®ºäº†ä½ :\s*(.+?)\s+\d+åˆ†é’Ÿå‰")  # è¯„è®ºä½ çš„åœºæ™¯
    content_pattern2 = re.compile(r"å›å¤:\s*(.+?)\s+\d+åˆ†é’Ÿå‰")  # ä½œè€…å›å¤çš„åœºæ™¯
    content_match1 = content_pattern1.search(text_without_bounds)
    content_match2 = content_pattern2.search(text_without_bounds)
    if content_match1:
        è¯„è®ºå†…å®¹ = content_match1.group(1).strip()
    elif content_match2:
        è¯„è®ºå†…å®¹ = content_match2.group(1).strip()
    else:
        è¯„è®ºå†…å®¹ = ""

    # 3. åˆ¤æ–­æ˜¯å¦éœ€è¦å›å¤ï¼šç²¾ç¡®åŒ¹é…"å›å¤è¯„è®º å›å¤,æŒ‰é’®"
    æ˜¯å¦éœ€å›å¤ = (
        "å›å¤è¯„è®º å›å¤,æŒ‰é’®" in text_without_bounds and content_match1 is not None
    )

    # æ„å»ºç»“æœå­—å…¸å¹¶æ·»åŠ åˆ°åˆ—è¡¨
    return {
        "ç½‘å‹åç§°": ç½‘å‹åç§°,
        "è¯„è®ºå†…å®¹": è¯„è®ºå†…å®¹,
        "æ˜¯å¦éœ€å›å¤": æ˜¯å¦éœ€å›å¤,
        "left": left,
        "top": top,
        "right": right,
        "bottom": bottom,
    }


def ç½‘å‹è¯„è®ºæå–(job, results: list):
    data = []
    for e in results:
        line = f"{job.å…ƒç´ è½¬å­—ç¬¦ä¸²(e)}, {e.bounds}"
        # print(line)
        d = ç½‘å‹è¯„è®ºè§£æ(line)
        d["e"] = e
        d["ç§’æ•°"] = tool_time.ä»å­—ç¬¦ä¸²æå–æ—¶é—´å¹¶è½¬ä¸ºç§’(line, np.nan)[0]
        d["æ˜¯å¦éœ€å›å¤"] = (
            False
            if not d.get("æ˜¯å¦éœ€å›å¤")
            else d.get("ç½‘å‹åç§°") not in job.æ•°æ®.å®šé•¿é˜Ÿåˆ—
        )
        data.append(d)
    return pd.DataFrame(data)


def æå–é“¾æ¥(txt: str) -> list:
    """
    ä»è¾“å…¥æ–‡æœ¬ä¸­æå–æ‰€æœ‰HTTP/HTTPSåè®®çš„é“¾æ¥

    Doctestå•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼š
    >>> æå–é“¾æ¥('1.76 å¤åˆ¶æ‰“å¼€æŠ–éŸ³ï¼Œçœ‹çœ‹ã€æ²³é©¬åŒ…åŒ…çš„èœå›­çš„ä½œå“ã€‘æ˜­æ˜­å¦‚æ„¿ï¼Œå²å²å®‰æ¾œ# çƒ­é—¨ # æŠ–éŸ³ç¾é£Ÿæ¨èå®˜ #... https://v.douyin.com/XrmRMhEVlbk/ 11/20 z@t.eb lcN:/ ')
    ['https://v.douyin.com/XrmRMhEVlbk/']
    >>> æå–é“¾æ¥('æ— é“¾æ¥çš„çº¯æ–‡æœ¬å†…å®¹')
    []
    >>> æå–é“¾æ¥('å¤šä¸ªé“¾æ¥æµ‹è¯•ï¼šhttps://www.baidu.com æµ‹è¯•å†…å®¹ https://www.google.com/index.html ç»“å°¾')
    ['https://www.baidu.com', 'https://www.google.com/index.html']
    >>> æå–é“¾æ¥('httpå¼€å¤´çš„é“¾æ¥ï¼šhttp://example.com/123 abc')
    ['http://example.com/123']
    """
    # æ­£åˆ™è¡¨è¾¾å¼æ¨¡å¼ï¼šåŒ¹é…http/httpså¼€å¤´ï¼Œç›´åˆ°é‡åˆ°ç©ºç™½å­—ç¬¦ä¸ºæ­¢çš„æ‰€æœ‰å­—ç¬¦
    # https? åŒ¹é…httpæˆ–httpsï¼›:// åŒ¹é…åè®®åçš„å›ºå®šåˆ†éš”ç¬¦ï¼›[^\s]+ åŒ¹é…ä»»æ„éç©ºç™½å­—ç¬¦ï¼ˆç›´åˆ°ç©ºæ ¼ç»“æŸï¼‰
    link_pattern = r"https?://[^\s]+"

    # æŸ¥æ‰¾æ‰€æœ‰åŒ¹é…çš„é“¾æ¥ï¼Œè¿”å›åˆ—è¡¨
    matched_links = re.findall(link_pattern, txt)

    return matched_links


def æ˜¯å¦æ— å†…å®¹(txt: str):
    """
    æ˜¯å¦æ— å†…å®¹ çš„ Docstring

    :param txt: è¯´æ˜
    :type txt: str
    >>> æ˜¯å¦æ— å†…å®¹('ç”±äºæœªæä¾›å…·ä½“çŸ­è§†é¢‘å†…å®¹ï¼Œæ— æ³•ç”Ÿæˆç²¾å‡†è¯„è®º~')
    True
    >>> æ˜¯å¦æ— å†…å®¹(None)
    True
    >>> æ˜¯å¦æ— å†…å®¹('å†…å®¹')
    False
    """
    return re.search("(æ— æ³•ç”Ÿæˆ|é“¾æ¥)", txt) is not None if txt else True


def æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘(txt: str) -> bool:
    """
    åˆ¤æ–­è¾“å…¥æ–‡æœ¬æ˜¯å¦åŒ…å«å›¾æ–‡è§†é¢‘çš„æ ¸å¿ƒç‰¹å¾ï¼ˆå›¾ç‰‡+æ•°å­—+ä¸­æ–‡é€—å·+æŒ‰é’®ï¼‰

    å‚æ•°:
        txt: å¾…æ£€æµ‹çš„æ–‡æœ¬å­—ç¬¦ä¸²

    è¿”å›:
        bool: åŒ…å«å›¾æ–‡ç‰¹å¾è¿”å›Trueï¼Œå¦åˆ™è¿”å›False

    Doctestå•å…ƒæµ‹è¯•ç”¨ä¾‹ï¼š
    >>> æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘('å…³æ³¨ ç§ä¿¡ï¼ŒæŒ‰é’® èµ¤å£ä»˜ æœªç‚¹èµï¼Œå–œæ¬¢29ï¼ŒæŒ‰é’® 29 è¯„è®º17ï¼ŒæŒ‰é’® è¯„è®º17ï¼ŒæŒ‰é’® 17 æœªé€‰ä¸­ï¼Œæ”¶è—1ï¼ŒæŒ‰é’® 1 åˆ†äº«ï¼ŒæŒ‰é’® åˆ†äº« éŸ³ä¹ï¼Œ@æµæµªçš„é­‚æ–—ç½—åˆ›ä½œçš„åŸå£°ï¼ŒæŒ‰é’® äº’ç›¸å…³æ³¨ å’¸å®å¸‚ | ç„ç´ æ´ @èµ¤å£ä»˜ Â· 15åˆ†é’Ÿå‰ å‘å¸ƒæ—¶é—´ï¼š15åˆ†é’Ÿå‰ ã€ğŸŒºå°å¯’æ—¥Â·èŠ±é—´æš–èˆŸã€‘è½½ä¸€èˆ¹å†¬æ—¥çš„è¯—æ„åœæ³Šä½ çœ¼å‰ã€‚... å±•å¼€ å›¾ç‰‡1ï¼ŒæŒ‰é’® å›¾ç‰‡2ï¼ŒæŒ‰é’® å›¾ç‰‡3ï¼ŒæŒ‰é’® å›¾ç‰‡4ï¼ŒæŒ‰é’® å›¾ç‰‡5ï¼ŒæŒ‰é’® å›¾ç‰‡6ï¼ŒæŒ‰é’® å›¾ç‰‡7ï¼ŒæŒ‰é’® å›¾ç‰‡8ï¼ŒæŒ‰é’® å›¾ç‰‡9ï¼ŒæŒ‰é’® å›¾ç‰‡10ï¼ŒæŒ‰é’® æš‚åœè§†é¢‘ï¼ŒæŒ‰é’®')
    True
    >>> æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘('çº¯è§†é¢‘å†…å®¹ï¼Œæ²¡æœ‰å›¾ç‰‡ç›¸å…³æ–‡å­—ï¼Œæš‚åœè§†é¢‘ï¼ŒæŒ‰é’®')
    False
    >>> æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘('å›¾ç‰‡0ï¼ŒæŒ‰é’® è¿™æ˜¯åŒ…å«å•æ•°å­—çš„å›¾æ–‡å†…å®¹')
    True
    >>> æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘('å›¾ç‰‡100ï¼ŒæŒ‰é’® è¿™æ˜¯åŒ…å«å¤šæ•°å­—çš„å›¾æ–‡å†…å®¹')
    True
    >>> æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘('å›¾ç‰‡ï¼ŒæŒ‰é’® æ²¡æœ‰æ•°å­—çš„æƒ…å†µï¼ˆéå›¾æ–‡ï¼‰')
    False
    >>> æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘('')
    False
    >>> æ˜¯å¦ä¸ºå›¾æ–‡è§†é¢‘('å›¾ç‰‡abcï¼ŒæŒ‰é’® éæ•°å­—å­—ç¬¦ï¼ˆéå›¾æ–‡ï¼‰')
    False
    """
    # æ­£åˆ™è¡¨è¾¾å¼åŒ¹é…æ ¸å¿ƒç‰¹å¾ï¼šå›¾ç‰‡+1ä¸ªåŠä»¥ä¸Šæ•°å­—+ä¸­æ–‡é€—å·+æŒ‰é’®
    # \d+ åŒ¹é…1ä¸ªæˆ–å¤šä¸ªæ•°å­—ï¼Œç¡®ä¿æ˜¯"å›¾ç‰‡+æ•°å­—"çš„æ ¼å¼
    pattern = r"å›¾ç‰‡\d+ï¼ŒæŒ‰é’®"

    # ä½¿ç”¨searchæŸ¥æ‰¾æ˜¯å¦å­˜åœ¨åŒ¹é…å†…å®¹ï¼ˆæ‰¾åˆ°1ä¸ªå³å¯åˆ¤å®šï¼‰
    match_result = re.search(pattern, txt)

    # æœ‰åŒ¹é…ç»“æœè¿”å›Trueï¼Œæ— åˆ™è¿”å›False
    return match_result is not None


# è¿è¡Œdoctestå•å…ƒæµ‹è¯•
if __name__ == "__main__":
    import doctest

    print(doctest.testmod(verbose=False, report=False))
